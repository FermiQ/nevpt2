```markdown
# `koopro4QD_main.F90` Program Documentation

## Program Name

`koopro4QD_main`

## Program Type

This is the main Fortran program (`PROGRAM`) that serves as the entry point for initiating the sequence of calculations related to Quasi-Degenerate N-Electron Valence State Perturbation Theory (QD-NEVPT2) intermediate quantity generation.

## Purpose

The primary purpose of `koopro4QD_main` is to:
1.  Read and parse essential configuration parameters from an input file named `input.nevpt`.
2.  Set up the calculation environment.
3.  Call the main computational driver subroutine `koopro4QD_driver` (from the `koopro4QD` module), which performs the detailed calculations of density matrices, Koopmans matrices, and other related quantities.
4.  Provide overall timing and logging for the execution.

It acts as the top-level executable that users would run to generate the data needed for subsequent QD-NEVPT2 energy calculations.

## Dependencies

*   **`koopro4QD` module:** Critically depends on this module for the `koopro4QD_driver` subroutine, which executes the core computational tasks.
*   **`nevpt_header` module:** Uses the `print_nevpt_header` subroutine to print a standard header for the calculation output.
*   **`input_reader_sections` module (implicitly):** Relies on a subroutine `read_menu_input` (assumed to be part of or used by `input_reader_sections.F90` or a similar input handling system) to parse specific sections from the input file. This `read_menu_input` would, in turn, use routines like `read_input_model` and `read_input_koopro` (defined in `input_reader_sections.F90`) to process keywords within those sections.
*   **`nevpt2_cfg` module (implicitly):** Configuration parameters read from the input file via `read_menu_input` are stored and accessed through this module (e.g., `no_4rdm_terms`).
*   **`omp_lib` module (conditional):** Used for OpenMP timing functions (`omp_get_wtime()`) if the program is compiled with OpenMP support.

## Input

*   **`input.nevpt` file:** This is the primary input file that `koopro4QD_main` expects.
    *   The program specifically attempts to read and parse two sections from this file using the `read_menu_input` subroutine (presumably with file unit 88):
        1.  `*MODEL `: This section is parsed first. It typically contains keywords defining the computational model, such as whether to use DMRG, Cholesky decomposition, or if 4-RDM terms should be skipped (e.g., keywords like `.DMRGPT`, `.CHOLES`, `.NO4RDM` which set flags in `nevpt2_cfg`).
        2.  `*KOOPRO`: This section is parsed second. It contains keywords related to the "Koopmans Procedure" setup, such as thresholds, spin state, number of states, active space definition (if not from MOLCAS), and paths to essential data files like `FILE04` (CI vectors) and `FILE50` (integrals) (e.g., keywords like `.THRESH`, `.SPIN`, `.STATES`, `.NACTEL`, `.NCORE`, `.NACTOR`, `.FILE04`, `.FILE50`).
    *   The program stops if these sections (or the input file itself) are not found or cannot be processed correctly.
    *   The content of `input.nevpt` is echoed to standard output using `call system('cat input.nevpt')`.

## Core Functionality

1.  **Set Defaults:** Initializes `rel_ham` (relativistic Hamiltonian flag) to `.FALSE.`.
2.  **Parse Input:**
    *   Calls `read_menu_input` to parse the `*MODEL ` section from `input.nevpt`.
    *   Calls `read_menu_input` again to parse the `*KOOPRO` section from `input.nevpt`.
    *   Checks an `input_found` flag (set by `read_menu_input`) and stops if critical input is missing.
3.  **Print Header:** Calls `print_nevpt_header(rel_ham)` to output standard information about the NEVPT2 calculation.
4.  **Log Initial Time:** Prints the current date and time.
5.  **Echo Input:** Displays the content of `input.nevpt`.
6.  **Pre-computation Check:** Prints a warning if the `no_4rdm_terms` flag (from `nevpt2_cfg`, set via `*MODEL ` section) is true, indicating that A-D matrices will not be calculated.
7.  **Call Main Driver:** Invokes the `koopro4QD_driver(rel_ham, t13, .FALSE.)` subroutine from the `koopro4QD` module.
    *   `rel_ham`: Passes the relativistic flag.
    *   `t13`: Receives the CPU time taken by the driver.
    *   `.FALSE.`: Indicates that the call is not directly from a MOLCAS interface context (relevant for how `koopro4QD_driver` initializes some components like orbital space information).
8.  **Log Final Time:** Prints final CPU time (from `t13`) and wall clock time (if OpenMP is enabled), along with the date and time of completion.

## Output

*   **Standard Output (Unit 6):** Program banner, logs, date/time stamps, echo of `input.nevpt`, warnings, and final timing information.
*   **HDF5 File (`nevpt.h5`):** All computationally significant output (density matrices, Koopmans matrices, etc.) is generated by the called `koopro4QD_driver` subroutine and written to this file. `koopro4QD_main` itself does not directly write to this file but initiates the process that does.

This program acts as the user-facing command to run the `koopro4QD` part of the NEVPT2 process, handling initial setup and delegating the complex calculations.
```
